#!/bin/sh


# These values have to be configured.
HOST=
REMOTE_USER=
PASS_USER=


# These values may be configured
INTERFACE=vpn
PID_FILE=/run/openconnect_${INTERFACE}.pid
PASS_PATH="${HOST}/${REMOTE_USER}/password"


source $XDG_CONFIG_HOME/vpn-script/config


PASS_CMD='pass $PASS_PATH | head -n1'

PASSWORD_CMD="if [[ $(whoami) == ${PASS_USER} ]]; then eval ${PASS_CMD}; else su ${PASS_USER} -c \"${PASS_CMD}\"; fi"

START_VPN="${PASSWORD_CMD} | sudo /usr/bin/openconnect --background --pid-file='${PID_FILE}' --interface='${INTERFACE}' --user='${REMOTE_USER}' --script='/etc/vpnc/vpnc-script-new' --passwd-on-stdin ${HOST}"
STATUS_VPN=
STOP_VPN='sudo kill -INT $(cat ${PID_FILE})'



show_status()
{
	if [[ -e ${PID_FILE} ]]; then
        echo ON
    else
        echo OFF
    fi
}

start_vpn()
{
    if [[ -e ${PID_FILE} ]]; then
        echo VPN already started.
    else
        echo Starting.
        eval $START_VPN >/dev/null
    fi
}

stop_vpn()
{
    if [[ -e ${PID_FILE} ]]; then
        echo Stopping
        eval $STOP_VPN
    else
        echo VPN was not started.
    fi
}


case $1 in
	start)
        start_vpn
		;;
	stop)
        stop_vpn
		;;
	status | '')
        show_status
		;;
	*)
		echo Unrecognized token.
        return -1
		;;
esac
